<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="401k_local_dev.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="browser query structure" current="0"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="17109"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="v_split_payment_distribution" custom_title="0" dock_id="1" table="4,28:mainv_split_payment_distribution"/><dock_state state="000000ff00000000fd000000010000000200000401000001f8fc0100000001fb000000160064006f0063006b00420072006f00770073006500310100000000000004010000011e00ffffff000002900000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="client_folders" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="58"/><column index="2" value="119"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_active_contracts" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="72"/><column index="2" value="56"/><column index="3" value="104"/><column index="4" value="72"/><column index="5" value="85"/><column index="6" value="80"/><column index="7" value="62"/><column index="8" value="113"/><column index="9" value="77"/><column index="10" value="156"/><column index="11" value="53"/><column index="12" value="58"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_all_missing_payment_periods" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="56"/><column index="2" value="113"/><column index="3" value="70"/><column index="4" value="77"/><column index="5" value="62"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_client_expected_periods" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="56"/><column index="2" value="113"/><column index="3" value="123"/><column index="4" value="128"/><column index="5" value="70"/><column index="6" value="77"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_current_period" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="85"/><column index="2" value="80"/><column index="3" value="92"/><column index="4" value="156"/><column index="5" value="187"/><column index="6" value="161"/><column index="7" value="192"/><column index="8" value="128"/><column index="9" value="133"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_current_period_payment_status" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="56"/><column index="2" value="113"/><column index="3" value="70"/><column index="4" value="77"/><column index="5" value="54"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_expanded_payment_periods" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="74"/><column index="2" value="56"/><column index="3" value="70"/><column index="4" value="113"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_payment_period_coverage" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="74"/><column index="2" value="56"/><column index="3" value="87"/><column index="4" value="70"/><column index="5" value="104"/><column index="6" value="300"/><column index="7" value="158"/><column index="9" value="186"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_payments" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="74"/><column index="2" value="72"/><column index="3" value="56"/><column index="4" value="87"/><column index="5" value="76"/><column index="6" value="70"/><column index="7" value="124"/><column index="8" value="300"/><column index="9" value="156"/><column index="10" value="53"/><column index="11" value="125"/><column index="12" value="156"/><column index="13" value="119"/><column index="14" value="151"/><column index="15" value="130"/><column index="16" value="161"/><column index="17" value="125"/><column index="18" value="156"/><column index="19" value="129"/><column index="20" value="135"/><column index="21" value="123"/><column index="22" value="128"/><column index="23" value="104"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="v_split_payment_distribution" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="74"/><column index="2" value="56"/><column index="3" value="148"/><column index="4" value="87"/><column index="5" value="139"/><column index="6" value="104"/><column index="7" value="133"/><column index="8" value="70"/><column index="9" value="77"/><column index="10" value="113"/><column index="11" value="118"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="SQL 1*">CREATE VIEW v_split_payment_distribution AS
-- Monthly periods
SELECT
    p.payment_id,
    p.client_id,
    c.display_name AS client_name,
    p.received_date,
    p.actual_fee AS total_payment_amount,
    1 AS is_split_payment,
    COUNT(*) OVER (PARTITION BY p.payment_id) AS total_periods_covered,
    dd.period_key_monthly AS period_key,
    dd.display_label_monthly AS period_label,
    'monthly' AS payment_schedule,
    ROUND(p.actual_fee / COUNT(*) OVER (PARTITION BY p.payment_id), 2) AS distributed_amount
FROM v_payments p
JOIN clients c ON p.client_id = c.client_id
JOIN date_dimension dd ON
    dd.period_key_monthly BETWEEN
    (p.applied_start_month_year * 100 + p.applied_start_month) AND
    (p.applied_end_month_year * 100 + p.applied_end_month)
WHERE 
    p.applied_start_month IS NOT NULL 
    AND p.valid_to IS NULL 
    AND p.is_split_payment = 1

UNION ALL

-- Quarterly periods
SELECT
    p.payment_id,
    p.client_id,
    c.display_name AS client_name,
    p.received_date,
    p.actual_fee AS total_payment_amount,
    1 AS is_split_payment,
    COUNT(*) OVER (PARTITION BY p.payment_id) AS total_periods_covered,
    dd.period_key_quarterly AS period_key,
    dd.display_label_quarterly AS period_label,
    'quarterly' AS payment_schedule,
    ROUND(p.actual_fee / COUNT(*) OVER (PARTITION BY p.payment_id), 2) AS distributed_amount
FROM v_payments p
JOIN clients c ON p.client_id = c.client_id
JOIN date_dimension dd ON
    dd.period_key_quarterly BETWEEN
    (p.applied_start_quarter_year * 10 + p.applied_start_quarter) AND
    (p.applied_end_quarter_year * 10 + p.applied_end_quarter)
    AND dd.month IN (1, 4, 7, 10)
WHERE 
    p.applied_start_quarter IS NOT NULL 
    AND p.valid_to IS NULL 
    AND p.is_split_payment = 1;</sql><current_tab id="0"/></tab_sql></sqlb_project>
